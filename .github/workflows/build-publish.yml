name: Build and Publish Base Images

on:
  push:
    branches: ["main"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Descobrir imagens alteradas
        id: set-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('node:child_process');

            // Para tags, construir todas as imagens
            if (context.ref.startsWith('refs/tags/')) {
              const out = execSync("git ls-files 'images/**/Dockerfile'", { encoding: 'utf8' });
              const lines = out.split('\n').filter(Boolean);
              const dirs = Array.from(new Set(lines.map(p => p.replace(/\/Dockerfile$/, ''))));
              const matrix = { image: dirs };
              core.setOutput('matrix', JSON.stringify(matrix));
              core.setOutput('has-changes', dirs.length > 0 ? 'true' : 'false');
              core.info(`Construindo todas as ${dirs.length} imagens (tag release)`);
              return;
            }

            // Para PRs, comparar com a base branch
            let baseRef = 'HEAD~1';
            if (context.eventName === 'pull_request') {
              baseRef = `origin/${context.payload.pull_request.base.ref}`;
              execSync(`git fetch origin ${context.payload.pull_request.base.ref}`, { encoding: 'utf8' });
            }

            // Obter lista de todos os Dockerfiles
            const allFiles = execSync("git ls-files 'images/**/Dockerfile'", { encoding: 'utf8' });
            const allLines = allFiles.split('\n').filter(Boolean);
            const allDirs = Array.from(new Set(allLines.map(p => p.replace(/\/Dockerfile$/, ''))));

            // Verificar quais foram alterados
            let changedFiles;
            try {
              changedFiles = execSync(`git diff --name-only ${baseRef} HEAD -- 'images/**/Dockerfile'`, { encoding: 'utf8' });
            } catch (e) {
              // Se não conseguir comparar (ex: primeiro commit), construir todas
              core.warning('Não foi possível comparar mudanças, construindo todas as imagens');
              const matrix = { image: allDirs };
              core.setOutput('matrix', JSON.stringify(matrix));
              core.setOutput('has-changes', allDirs.length > 0 ? 'true' : 'false');
              return;
            }

            const changedLines = changedFiles.split('\n').filter(Boolean);

            if (changedLines.length === 0) {
              core.info('Nenhum Dockerfile foi alterado, pulando build');
              const matrix = { image: [] };
              core.setOutput('matrix', JSON.stringify(matrix));
              core.setOutput('has-changes', 'false');
              return;
            }

            // Extrair diretórios das imagens alteradas
            const changedDirs = Array.from(new Set(
              changedLines.map(p => p.replace(/\/Dockerfile$/, ''))
            ));

            core.info(`Imagens alteradas: ${changedDirs.join(', ')}`);
            const matrix = { image: changedDirs };
            core.setOutput('matrix', JSON.stringify(matrix));
            core.setOutput('has-changes', changedDirs.length > 0 ? 'true' : 'false');
            core.info(`Outputs definidos - has-changes: ${changedDirs.length > 0 ? 'true' : 'false'}, imagens: ${changedDirs.length}`);

  build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.has-changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar QEMU
        uses: docker/setup-qemu-action@v3

      - name: Configurar Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Definir metadados
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image && matrix.image != '' && matrix.image != null && matrix.image || 'image' }}
          tags: |
            type=raw,value=edge,enable=${{ github.ref == 'refs/heads/main' }}
            type=ref,event=tag,enable=true
            type=raw,value=pr-${{ github.event.pull_request.number }},enable=${{ github.event_name == 'pull_request' }}
          flavor: |
            latest=true

      - name: Build e Push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.image }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Log tags geradas
        run: |
          echo "Tags geradas para ${{ matrix.image }}: ${{ steps.meta.outputs.tags }}"

  scan:
    needs: [discover, build]
    if: needs.discover.outputs.has-changes == 'true' && needs.build.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.discover.outputs.matrix) }}
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verificar se Docker Scout está configurado
        id: check-scout
        run: |
          if [ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::warning::Docker Scout não configurado. Configure os secrets DOCKER_HUB_USERNAME e DOCKER_HUB_TOKEN para habilitar scan de vulnerabilidades."
          fi

      - name: Login no Docker Hub (para Docker Scout)
        if: steps.check-scout.outputs.enabled == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME || 'githubactions' }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Determinar tag para scan
        id: tag-info
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          # Prioriza edge para main, depois tenta outras tags
          if [[ "${{ github.ref }}" == refs/heads/main ]]; then
            SCAN_TAG="${IMAGE_NAME}:edge"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SCAN_TAG="${IMAGE_NAME}:pr-${{ github.event.pull_request.number }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Para tags, tenta a versão específica primeiro, depois latest
            TAG_VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v\?//')
            SCAN_TAG="${IMAGE_NAME}:${TAG_VERSION}"
            echo "Tentando tag específica: ${SCAN_TAG}"
          else
            SCAN_TAG="${IMAGE_NAME}:edge"
          fi
          echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          echo "Escaneando: ${SCAN_TAG}"

      - name: Verificar se imagem está acessível
        if: steps.check-scout.outputs.enabled == 'true'
        id: verify-image
        run: |
          SCAN_TAG="${{ steps.tag-info.outputs.scan-tag }}"
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Verificando se imagem ${SCAN_TAG} está acessível..."
          # Tenta puxar a imagem para verificar se está disponível
          if docker pull "${SCAN_TAG}" 2>&1; then
            echo "✅ Imagem encontrada e acessível: ${SCAN_TAG}"
            echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          else
            echo "Aviso: Imagem ${SCAN_TAG} não encontrada, tentando latest..."
            LATEST_TAG="${IMAGE_NAME}:latest"
            if docker pull "${LATEST_TAG}" 2>&1; then
              echo "✅ Usando tag latest: ${LATEST_TAG}"
              echo "scan-tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            else
              echo "::warning::Imagem não encontrada no GHCR. Scan pode falhar, mas continuando com tag original."
              echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Docker Scout CVEs
        if: steps.check-scout.outputs.enabled == 'true'
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}
          only-severities: critical,high
          exit-code: true
          ignore-base: false
          format: sarif
          output: docker-scout-report.sarif

      - name: Upload SARIF
        if: always() && steps.check-scout.outputs.enabled == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: docker-scout-report.sarif
          category: docker-scout

  summary:
    needs: [discover, build, scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Workflow Summary
        run: |
          echo "## Workflow Status" >> $GITHUB_STEP_SUMMARY
          echo "- Discover: ${{ needs.discover.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Scan: ${{ needs.scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.discover.outputs.has-changes }}" == "false" ]; then
            echo "ℹ️ Nenhuma imagem foi alterada, build e scan foram pulados." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ Workflow executado com sucesso!" >> $GITHUB_STEP_SUMMARY
          fi
