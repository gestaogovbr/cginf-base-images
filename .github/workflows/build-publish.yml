name: Build and Publish Base Images

on:
  push:
    branches: ["main"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Descobrir imagens alteradas
        id: set-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('node:child_process');

            // Para tags, construir todas as imagens
            if (context.ref.startsWith('refs/tags/')) {
              const out = execSync("git ls-files 'images/**/Dockerfile'", { encoding: 'utf8' });
              const lines = out.split('\n').filter(Boolean);
              const dirs = Array.from(new Set(lines.map(p => p.replace(/\/Dockerfile$/, ''))));
              const matrix = { image: dirs };
              core.setOutput('matrix', JSON.stringify(matrix));
              core.setOutput('has-changes', dirs.length > 0 ? 'true' : 'false');
              core.info(`Construindo todas as ${dirs.length} imagens (tag release)`);
              return;
            }

            // Para PRs, comparar com a base branch
            let baseRef = 'HEAD~1';
            if (context.eventName === 'pull_request') {
              baseRef = `origin/${context.payload.pull_request.base.ref}`;
              execSync(`git fetch origin ${context.payload.pull_request.base.ref}`, { encoding: 'utf8' });
            }

            // TEMPORÁRIO: Trabalhando apenas com PostgreSQL para testes
            // const allFiles = execSync("git ls-files 'images/**/Dockerfile'", { encoding: 'utf8' });
            // const allLines = allFiles.split('\n').filter(Boolean);
            // const allDirs = Array.from(new Set(allLines.map(p => p.replace(/\/Dockerfile$/, ''))));

            // Verificar quais foram alterados - TEMPORARIAMENTE DESABILITADO
            // let changedFiles;
            // try {
            //   changedFiles = execSync(`git diff --name-only ${baseRef} HEAD -- 'images/**/Dockerfile'`, { encoding: 'utf8' });
            // } catch (e) {
            //   core.warning('Não foi possível comparar mudanças, construindo todas as imagens');
            //   const matrix = { image: allDirs };
            //   core.setOutput('matrix', JSON.stringify(matrix));
            //   core.setOutput('has-changes', allDirs.length > 0 ? 'true' : 'false');
            //   return;
            // }

            // const changedLines = changedFiles.split('\n').filter(Boolean);

            // if (changedLines.length === 0) {
            //   core.info('Nenhum Dockerfile foi alterado, pulando build');
            //   const matrix = { image: [] };
            //   core.setOutput('matrix', JSON.stringify(matrix));
            //   core.setOutput('has-changes', 'false');
            //   return;
            // }

            // const changedDirs = Array.from(new Set(
            //   changedLines.map(p => p.replace(/\/Dockerfile$/, ''))
            // ));

            // TEMPORÁRIO: Apenas PostgreSQL
            const matrix = { image: ['images/postgres-16'] };
            core.setOutput('matrix', JSON.stringify(matrix));
            core.setOutput('has-changes', 'true');
            core.info('TEMPORÁRIO: Trabalhando apenas com PostgreSQL (images/postgres-16)');

  build:
    needs: discover
    runs-on: ubuntu-latest
    # if: needs.discover.outputs.has-changes == 'true'  # Temporariamente desabilitado para testes
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar QEMU
        uses: docker/setup-qemu-action@v3

      - name: Configurar Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Definir metadados
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}
          tags: |
            type=raw,value=edge,enable=${{ github.ref == 'refs/heads/main' }}
            type=ref,event=tag,enable=true
            type=raw,value=pr-${{ github.event.pull_request.number }},enable=${{ github.event_name == 'pull_request' }}
          flavor: |
            latest=true

      - name: Build e Push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.image }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Log tags geradas
        run: |
          echo "Tags geradas para ${{ matrix.image }}: ${{ steps.meta.outputs.tags }}"

  scan:
    needs: [discover, build]
    # if: needs.discover.outputs.has-changes == 'true' && needs.build.result == 'success'  # Temporariamente desabilitado para testes
    if: needs.build.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ["images/postgres-16"] # Temporariamente apenas PostgreSQL
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Debug - Verificar condições
        run: |
          echo "has-changes: ${{ needs.discover.outputs.has-changes }}"
          echo "build.result: ${{ needs.build.result }}"
          echo "matrix: ${{ needs.discover.outputs.matrix }}"
          echo "matrix.image: ${{ matrix.image }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verificar se Docker Scout está configurado
        id: check-scout
        run: |
          echo "=== Debug Docker Scout Configuration ==="
          if [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            USERNAME_LEN=${#DOCKER_HUB_USERNAME}
            echo "✅ DOCKER_HUB_USERNAME está configurado (tamanho: ${USERNAME_LEN} caracteres)"
            echo "Username (primeiros 3 chars): $(echo "${{ secrets.DOCKER_HUB_USERNAME }}" | cut -c1-3)***"
          else
            echo "❌ DOCKER_HUB_USERNAME NÃO está configurado"
          fi

          if [ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
            TOKEN_LEN=${#DOCKER_HUB_TOKEN}
            echo "✅ DOCKER_HUB_TOKEN está configurado (tamanho: ${TOKEN_LEN} caracteres)"
            echo "Token (primeiros 4 chars): $(echo "${{ secrets.DOCKER_HUB_TOKEN }}" | cut -c1-4)***"
          else
            echo "❌ DOCKER_HUB_TOKEN NÃO está configurado"
          fi
          echo "========================================"

          if [ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ] && [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "✅ Docker Scout configurado e habilitado"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::warning::Docker Scout não configurado. Configure os secrets DOCKER_HUB_USERNAME e DOCKER_HUB_TOKEN para habilitar scan de vulnerabilidades."
            if [ -z "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
              echo "::warning::DOCKER_HUB_USERNAME não está configurado"
            fi
            if [ -z "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
              echo "::warning::DOCKER_HUB_TOKEN não está configurado"
            fi
          fi

      - name: Debug Login Docker Hub
        if: steps.check-scout.outputs.enabled == 'true'
        run: |
          echo "=== Debug Login Docker Hub ==="
          echo "Tentando fazer login com username: ${{ secrets.DOCKER_HUB_USERNAME }}"
          echo "Token configurado: $([ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ] && echo "Sim" || echo "Não")"
          echo "==============================="

      - name: Login no Docker Hub (para Docker Scout)
        if: steps.check-scout.outputs.enabled == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          logout: false

      - name: Determinar tag para scan
        id: tag-info
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Nome da imagem para scan: ${IMAGE_NAME}"
          # Para main, usa edge ou latest (se edge não existir)
          if [[ "${{ github.ref }}" == refs/heads/main ]]; then
            # Tenta edge primeiro, se não existir usa latest
            SCAN_TAG="${IMAGE_NAME}:edge"
            echo "Tentando tag edge: ${SCAN_TAG}"
            # Verifica se edge existe, se não, usa latest
            if ! docker manifest inspect "${SCAN_TAG}" >/dev/null 2>&1; then
              echo "Tag edge não encontrada, usando latest"
              SCAN_TAG="${IMAGE_NAME}:latest"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SCAN_TAG="${IMAGE_NAME}:pr-${{ github.event.pull_request.number }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Para tags, tenta a versão específica primeiro, depois latest
            TAG_VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v\?//')
            SCAN_TAG="${IMAGE_NAME}:${TAG_VERSION}"
            echo "Tentando tag específica: ${SCAN_TAG}"
          else
            # Fallback para latest se nada funcionar
            SCAN_TAG="${IMAGE_NAME}:latest"
          fi
          echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          echo "Escaneando: ${SCAN_TAG}"

      - name: Verificar se imagem está acessível
        if: steps.check-scout.outputs.enabled == 'true'
        id: verify-image
        run: |
          SCAN_TAG="${{ steps.tag-info.outputs.scan-tag }}"
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Verificando se imagem ${SCAN_TAG} está acessível..."
          # Tenta puxar a imagem para verificar se está disponível
          if docker pull "${SCAN_TAG}" 2>&1; then
            echo "✅ Imagem encontrada e acessível: ${SCAN_TAG}"
            echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          else
            echo "Aviso: Imagem ${SCAN_TAG} não encontrada, tentando latest..."
            LATEST_TAG="${IMAGE_NAME}:latest"
            if docker pull "${LATEST_TAG}" 2>&1; then
              echo "✅ Usando tag latest: ${LATEST_TAG}"
              echo "scan-tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            else
              echo "::warning::Imagem não encontrada no GHCR. Scan pode falhar, mas continuando com tag original."
              echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Verificar autenticação GHCR antes do scan
        if: steps.check-scout.outputs.enabled == 'true'
        run: |
          echo "Verificando autenticação no GHCR..."
          SCAN_TAG="${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}"
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Tentando puxar imagem: ${SCAN_TAG}"
          # Tenta a tag específica primeiro
          if docker pull "${SCAN_TAG}" 2>&1; then
            echo "✅ Imagem acessível via Docker: ${SCAN_TAG}"
          else
            echo "Tag ${SCAN_TAG} não encontrada, tentando latest..."
            if docker pull "${IMAGE_NAME}:latest" 2>&1; then
              echo "✅ Usando tag latest: ${IMAGE_NAME}:latest"
              echo "scan-tag=${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
            else
              echo "::warning::Não foi possível acessar a imagem no GHCR"
              echo "Tentando scan mesmo assim..."
              # Não falha, deixa o Docker Scout tentar
            fi
          fi

      - name: Docker Scout CVEs
        if: steps.check-scout.outputs.enabled == 'true'
        id: scout-cves
        continue-on-error: true
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}
          only-severities: critical,high
          exit-code: false
          ignore-base: false
          format: sarif
          sarif-file: docker-scout-report.sarif

      - name: Debug - Verificar arquivos gerados
        if: steps.check-scout.outputs.enabled == 'true'
        run: |
          echo "Listando arquivos no diretório atual:"
          ls -la
          echo ""
          echo "Verificando se arquivo SARIF existe:"
          if [ -f "docker-scout-report.sarif" ]; then
            echo "✅ Arquivo encontrado!"
            echo "Tamanho: $(stat -f%z docker-scout-report.sarif 2>/dev/null || stat -c%s docker-scout-report.sarif 2>/dev/null || echo 'N/A') bytes"
          else
            echo "❌ Arquivo não encontrado"
            echo "Verificando se há outros arquivos .sarif:"
            find . -name "*.sarif" 2>/dev/null || echo "Nenhum arquivo .sarif encontrado"
          fi

      - name: Verificar se arquivo SARIF existe
        if: always() && steps.check-scout.outputs.enabled == 'true'
        id: check-sarif
        run: |
          if [ -f "docker-scout-report.sarif" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Arquivo SARIF encontrado"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Arquivo docker-scout-report.sarif não foi gerado"
          fi

      - name: Upload SARIF
        if: always() && steps.check-scout.outputs.enabled == 'true' && steps.check-sarif.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: docker-scout-report.sarif
          category: docker-scout

  scan-trivy:
    needs: [discover, build]
    if: needs.build.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ["images/postgres-16"] # Temporariamente apenas PostgreSQL
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determinar tag para scan
        id: tag-info
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Nome da imagem para scan Trivy: ${IMAGE_NAME}"
          # Para main, usa edge ou latest (se edge não existir)
          if [[ "${{ github.ref }}" == refs/heads/main ]]; then
            # Tenta edge primeiro, se não existir usa latest
            SCAN_TAG="${IMAGE_NAME}:edge"
            echo "Tentando tag edge: ${SCAN_TAG}"
            # Verifica se edge existe, se não, usa latest
            if ! docker manifest inspect "${SCAN_TAG}" >/dev/null 2>&1; then
              echo "Tag edge não encontrada, usando latest"
              SCAN_TAG="${IMAGE_NAME}:latest"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SCAN_TAG="${IMAGE_NAME}:pr-${{ github.event.pull_request.number }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Para tags, tenta a versão específica primeiro, depois latest
            TAG_VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v\?//')
            SCAN_TAG="${IMAGE_NAME}:${TAG_VERSION}"
            echo "Tentando tag específica: ${SCAN_TAG}"
          else
            # Fallback para latest se nada funcionar
            SCAN_TAG="${IMAGE_NAME}:latest"
          fi
          echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          echo "Escaneando com Trivy: ${SCAN_TAG}"

      - name: Verificar se imagem está acessível
        id: verify-image
        run: |
          SCAN_TAG="${{ steps.tag-info.outputs.scan-tag }}"
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Verificando se imagem ${SCAN_TAG} está acessível..."
          # Tenta puxar a imagem para verificar se está disponível
          if docker pull "${SCAN_TAG}" 2>&1; then
            echo "✅ Imagem encontrada e acessível: ${SCAN_TAG}"
            echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          else
            echo "Aviso: Imagem ${SCAN_TAG} não encontrada, tentando latest..."
            LATEST_TAG="${IMAGE_NAME}:latest"
            if docker pull "${LATEST_TAG}" 2>&1; then
              echo "✅ Usando tag latest: ${LATEST_TAG}"
              echo "scan-tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            else
              echo "::warning::Imagem não encontrada no GHCR. Scan pode falhar, mas continuando com tag original."
              echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Trivy Scan - Vulnerabilidades (Table)
        id: trivy-scan-table
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          ignore-unfixed: false

      - name: Trivy Scan - Vulnerabilidades (SARIF)
        id: trivy-scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}
          format: "sarif"
          output: "trivy-report.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          ignore-unfixed: false

      - name: Verificar se arquivo SARIF do Trivy existe
        if: always()
        id: check-trivy-sarif
        run: |
          if [ -f "trivy-report.sarif" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Arquivo SARIF do Trivy encontrado"
            echo "Tamanho: $(stat -f%z trivy-report.sarif 2>/dev/null || stat -c%s trivy-report.sarif 2>/dev/null || echo 'N/A') bytes"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Arquivo trivy-report.sarif não foi gerado"
          fi

      - name: Upload SARIF do Trivy
        if: always() && steps.check-trivy-sarif.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-report.sarif
          category: trivy

  summary:
    needs: [discover, build, scan, scan-trivy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Workflow Summary
        run: |
          echo "## Workflow Status" >> $GITHUB_STEP_SUMMARY
          echo "- Discover: ${{ needs.discover.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Scan (Docker Scout): ${{ needs.scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Scan (Trivy): ${{ needs.scan-trivy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.discover.outputs.has-changes }}" == "false" ]; then
            echo "ℹ️ Nenhuma imagem foi alterada, build e scans foram pulados." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ Workflow executado com sucesso!" >> $GITHUB_STEP_SUMMARY
          fi
