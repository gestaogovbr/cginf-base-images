name: Build and Publish Base Images

on:
  push:
    branches: ["main"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Descobrir imagens alteradas
        id: set-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('node:child_process');

            // Para tags, construir todas as imagens
            if (context.ref.startsWith('refs/tags/')) {
              const out = execSync("git ls-files 'images/**/Dockerfile'", { encoding: 'utf8' });
              const lines = out.split('\n').filter(Boolean);
              const dirs = Array.from(new Set(lines.map(p => p.replace(/\/Dockerfile$/, ''))));
              const matrix = { image: dirs };
              core.setOutput('matrix', JSON.stringify(matrix));
              core.setOutput('has-changes', dirs.length > 0 ? 'true' : 'false');
              core.info(`Construindo todas as ${dirs.length} imagens (tag release)`);
              return;
            }

            // Para PRs, comparar com a base branch
            let baseRef = 'HEAD~1';
            if (context.eventName === 'pull_request') {
              baseRef = `origin/${context.payload.pull_request.base.ref}`;
              execSync(`git fetch origin ${context.payload.pull_request.base.ref}`, { encoding: 'utf8' });
            }

            // Obter lista de todos os Dockerfiles
            const allFiles = execSync("git ls-files 'images/**/Dockerfile'", { encoding: 'utf8' });
            const allLines = allFiles.split('\n').filter(Boolean);
            const allDirs = Array.from(new Set(allLines.map(p => p.replace(/\/Dockerfile$/, ''))));

            // Verificar quais foram alterados
            let changedFiles;
            try {
              changedFiles = execSync(`git diff --name-only ${baseRef} HEAD -- 'images/**/Dockerfile'`, { encoding: 'utf8' });
            } catch (e) {
              // Se não conseguir comparar (ex: primeiro commit), construir todas
              core.warning('Não foi possível comparar mudanças, construindo todas as imagens');
              const matrix = { image: allDirs };
              core.setOutput('matrix', JSON.stringify(matrix));
              core.setOutput('has-changes', allDirs.length > 0 ? 'true' : 'false');
              return;
            }

            const changedLines = changedFiles.split('\n').filter(Boolean);

            if (changedLines.length === 0) {
              core.info('Nenhum Dockerfile foi alterado, pulando build');
              const matrix = { image: [] };
              core.setOutput('matrix', JSON.stringify(matrix));
              core.setOutput('has-changes', 'false');
              return;
            }

            // Extrair diretórios das imagens alteradas
            const changedDirs = Array.from(new Set(
              changedLines.map(p => p.replace(/\/Dockerfile$/, ''))
            ));

            core.info(`Imagens alteradas: ${changedDirs.join(', ')}`);
            const matrix = { image: changedDirs };
            core.setOutput('matrix', JSON.stringify(matrix));
            core.setOutput('has-changes', changedDirs.length > 0 ? 'true' : 'false');

  build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.has-changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar QEMU
        uses: docker/setup-qemu-action@v3

      - name: Configurar Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Definir metadados
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image && matrix.image != '' && matrix.image != null && matrix.image || 'image' }}
          tags: |
            type=raw,value=edge,enable=${{ github.ref == 'refs/heads/main' }}
            type=ref,event=tag,enable=true
            type=raw,value=pr-${{ github.event.pull_request.number }},enable=${{ github.event_name == 'pull_request' }}
          flavor: |
            latest=true

      - name: Build e Push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.image }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  scan:
    needs: [discover, build]
    runs-on: ubuntu-latest
    if: needs.discover.outputs.has-changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determinar tag para scan
        id: tag-info
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Para tags, usa a tag específica ou latest
            SCAN_TAG="${IMAGE_NAME}:latest"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Para PRs, usa a tag pr-*
            SCAN_TAG="${IMAGE_NAME}:pr-${{ github.event.pull_request.number }}"
          else
            # Para main, usa edge
            SCAN_TAG="${IMAGE_NAME}:edge"
          fi
          echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          echo "Escaneando: ${SCAN_TAG}"

      - name: Docker Scout CVEs
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ steps.tag-info.outputs.scan-tag }}
          only-severities: critical,high
          exit-code: true
          ignore-base: false
          format: sarif
          output: docker-scout-report.sarif

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: docker-scout-report.sarif
          category: docker-scout
