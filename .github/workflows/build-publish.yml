name: Build and Publish Base Images

on:
  push:
    branches: ["main"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Descobrir imagens alteradas
        id: set-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('node:child_process');

            // Para tags, construir todas as imagens
            if (context.ref.startsWith('refs/tags/')) {
              const out = execSync("git ls-files 'images/**/Dockerfile'", { encoding: 'utf8' });
              const lines = out.split('\n').filter(Boolean);
              const dirs = Array.from(new Set(lines.map(p => p.replace(/\/Dockerfile$/, ''))));
              const matrix = { image: dirs };
              core.setOutput('matrix', JSON.stringify(matrix));
              core.setOutput('has-changes', dirs.length > 0 ? 'true' : 'false');
              core.info(`Construindo todas as ${dirs.length} imagens (tag release)`);
              return;
            }

            // Para PRs, comparar com a base branch
            let baseRef = 'HEAD~1';
            if (context.eventName === 'pull_request') {
              baseRef = `origin/${context.payload.pull_request.base.ref}`;
              execSync(`git fetch origin ${context.payload.pull_request.base.ref}`, { encoding: 'utf8' });
            }

            // TEMPOR√ÅRIO: Trabalhando apenas com PostgreSQL para testes
            // const allFiles = execSync("git ls-files 'images/**/Dockerfile'", { encoding: 'utf8' });
            // const allLines = allFiles.split('\n').filter(Boolean);
            // const allDirs = Array.from(new Set(allLines.map(p => p.replace(/\/Dockerfile$/, ''))));

            // Verificar quais foram alterados - TEMPORARIAMENTE DESABILITADO
            // let changedFiles;
            // try {
            //   changedFiles = execSync(`git diff --name-only ${baseRef} HEAD -- 'images/**/Dockerfile'`, { encoding: 'utf8' });
            // } catch (e) {
            //   core.warning('N√£o foi poss√≠vel comparar mudan√ßas, construindo todas as imagens');
            //   const matrix = { image: allDirs };
            //   core.setOutput('matrix', JSON.stringify(matrix));
            //   core.setOutput('has-changes', allDirs.length > 0 ? 'true' : 'false');
            //   return;
            // }

            // const changedLines = changedFiles.split('\n').filter(Boolean);

            // if (changedLines.length === 0) {
            //   core.info('Nenhum Dockerfile foi alterado, pulando build');
            //   const matrix = { image: [] };
            //   core.setOutput('matrix', JSON.stringify(matrix));
            //   core.setOutput('has-changes', 'false');
            //   return;
            // }

            // const changedDirs = Array.from(new Set(
            //   changedLines.map(p => p.replace(/\/Dockerfile$/, ''))
            // ));

            // TEMPOR√ÅRIO: Apenas PostgreSQL
            const matrix = { image: ['images/postgres-16'] };
            core.setOutput('matrix', JSON.stringify(matrix));
            core.setOutput('has-changes', 'true');
            core.info('TEMPOR√ÅRIO: Trabalhando apenas com PostgreSQL (images/postgres-16)');

  build:
    needs: discover
    runs-on: ubuntu-latest
    # if: needs.discover.outputs.has-changes == 'true'  # Temporariamente desabilitado para testes
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar QEMU
        uses: docker/setup-qemu-action@v3

      - name: Configurar Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Definir metadados
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}
          tags: |
            type=raw,value=edge,enable=${{ github.ref == 'refs/heads/main' }}
            type=ref,event=tag,enable=true
            type=raw,value=pr-${{ github.event.pull_request.number }},enable=${{ github.event_name == 'pull_request' }}
          flavor: |
            latest=true

      - name: Build e Push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.image }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Log tags geradas
        run: |
          echo "Tags geradas para ${{ matrix.image }}: ${{ steps.meta.outputs.tags }}"

  scan:
    needs: [discover, build]
    # if: needs.discover.outputs.has-changes == 'true' && needs.build.result == 'success'  # Temporariamente desabilitado para testes
    if: needs.build.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ["images/postgres-16"] # Temporariamente apenas PostgreSQL
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Debug - Verificar condi√ß√µes
        run: |
          echo "has-changes: ${{ needs.discover.outputs.has-changes }}"
          echo "build.result: ${{ needs.build.result }}"
          echo "matrix: ${{ needs.discover.outputs.matrix }}"
          echo "matrix.image: ${{ matrix.image }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verificar se Docker Scout est√° configurado
        id: check-scout
        run: |
          echo "=== Debug Docker Scout Configuration ==="
          if [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            USERNAME_LEN=${#DOCKER_HUB_USERNAME}
            echo "‚úÖ DOCKER_HUB_USERNAME est√° configurado (tamanho: ${USERNAME_LEN} caracteres)"
            echo "Username (primeiros 3 chars): $(echo "${{ secrets.DOCKER_HUB_USERNAME }}" | cut -c1-3)***"
          else
            echo "‚ùå DOCKER_HUB_USERNAME N√ÉO est√° configurado"
          fi

          if [ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
            TOKEN_LEN=${#DOCKER_HUB_TOKEN}
            echo "‚úÖ DOCKER_HUB_TOKEN est√° configurado (tamanho: ${TOKEN_LEN} caracteres)"
            echo "Token (primeiros 4 chars): $(echo "${{ secrets.DOCKER_HUB_TOKEN }}" | cut -c1-4)***"
          else
            echo "‚ùå DOCKER_HUB_TOKEN N√ÉO est√° configurado"
          fi
          echo "========================================"

          if [ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ] && [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Docker Scout configurado e habilitado"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::warning::Docker Scout n√£o configurado. Configure os secrets DOCKER_HUB_USERNAME e DOCKER_HUB_TOKEN para habilitar scan de vulnerabilidades."
            if [ -z "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
              echo "::warning::DOCKER_HUB_USERNAME n√£o est√° configurado"
            fi
            if [ -z "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
              echo "::warning::DOCKER_HUB_TOKEN n√£o est√° configurado"
            fi
          fi

      - name: Debug Login Docker Hub
        if: steps.check-scout.outputs.enabled == 'true'
        run: |
          echo "=== Debug Login Docker Hub ==="
          echo "Tentando fazer login com username: ${{ secrets.DOCKER_HUB_USERNAME }}"
          echo "Token configurado: $([ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ] && echo "Sim" || echo "N√£o")"
          echo "==============================="

      - name: Login no Docker Hub (para Docker Scout)
        if: steps.check-scout.outputs.enabled == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          logout: false

      - name: Determinar tag para scan
        id: tag-info
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Nome da imagem para scan: ${IMAGE_NAME}"
          # Para main, usa edge ou latest (se edge n√£o existir)
          if [[ "${{ github.ref }}" == refs/heads/main ]]; then
            # Tenta edge primeiro, se n√£o existir usa latest
            SCAN_TAG="${IMAGE_NAME}:edge"
            echo "Tentando tag edge: ${SCAN_TAG}"
            # Verifica se edge existe, se n√£o, usa latest
            if ! docker manifest inspect "${SCAN_TAG}" >/dev/null 2>&1; then
              echo "Tag edge n√£o encontrada, usando latest"
              SCAN_TAG="${IMAGE_NAME}:latest"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SCAN_TAG="${IMAGE_NAME}:pr-${{ github.event.pull_request.number }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Para tags, tenta a vers√£o espec√≠fica primeiro, depois latest
            TAG_VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v\?//')
            SCAN_TAG="${IMAGE_NAME}:${TAG_VERSION}"
            echo "Tentando tag espec√≠fica: ${SCAN_TAG}"
          else
            # Fallback para latest se nada funcionar
            SCAN_TAG="${IMAGE_NAME}:latest"
          fi
          echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          echo "Escaneando: ${SCAN_TAG}"

      - name: Verificar se imagem est√° acess√≠vel
        if: steps.check-scout.outputs.enabled == 'true'
        id: verify-image
        run: |
          SCAN_TAG="${{ steps.tag-info.outputs.scan-tag }}"
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Verificando se imagem ${SCAN_TAG} est√° acess√≠vel..."
          # Tenta puxar a imagem para verificar se est√° dispon√≠vel
          if docker pull "${SCAN_TAG}" 2>&1; then
            echo "‚úÖ Imagem encontrada e acess√≠vel: ${SCAN_TAG}"
            echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          else
            echo "Aviso: Imagem ${SCAN_TAG} n√£o encontrada, tentando latest..."
            LATEST_TAG="${IMAGE_NAME}:latest"
            if docker pull "${LATEST_TAG}" 2>&1; then
              echo "‚úÖ Usando tag latest: ${LATEST_TAG}"
              echo "scan-tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            else
              echo "::warning::Imagem n√£o encontrada no GHCR. Scan pode falhar, mas continuando com tag original."
              echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Verificar autentica√ß√£o GHCR antes do scan
        if: steps.check-scout.outputs.enabled == 'true'
        run: |
          echo "Verificando autentica√ß√£o no GHCR..."
          SCAN_TAG="${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}"
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Tentando puxar imagem: ${SCAN_TAG}"
          # Tenta a tag espec√≠fica primeiro
          if docker pull "${SCAN_TAG}" 2>&1; then
            echo "‚úÖ Imagem acess√≠vel via Docker: ${SCAN_TAG}"
          else
            echo "Tag ${SCAN_TAG} n√£o encontrada, tentando latest..."
            if docker pull "${IMAGE_NAME}:latest" 2>&1; then
              echo "‚úÖ Usando tag latest: ${IMAGE_NAME}:latest"
              echo "scan-tag=${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
            else
              echo "::warning::N√£o foi poss√≠vel acessar a imagem no GHCR"
              echo "Tentando scan mesmo assim..."
              # N√£o falha, deixa o Docker Scout tentar
            fi
          fi

      - name: Docker Scout CVEs
        if: steps.check-scout.outputs.enabled == 'true'
        id: scout-cves
        continue-on-error: true
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}
          only-severities: critical,high
          exit-code: false
          ignore-base: false
          format: sarif
          sarif-file: docker-scout-report.sarif

      - name: Debug - Verificar arquivos gerados
        if: steps.check-scout.outputs.enabled == 'true'
        run: |
          echo "Listando arquivos no diret√≥rio atual:"
          ls -la
          echo ""
          echo "Verificando se arquivo SARIF existe:"
          if [ -f "docker-scout-report.sarif" ]; then
            echo "‚úÖ Arquivo encontrado!"
            echo "Tamanho: $(stat -f%z docker-scout-report.sarif 2>/dev/null || stat -c%s docker-scout-report.sarif 2>/dev/null || echo 'N/A') bytes"
          else
            echo "‚ùå Arquivo n√£o encontrado"
            echo "Verificando se h√° outros arquivos .sarif:"
            find . -name "*.sarif" 2>/dev/null || echo "Nenhum arquivo .sarif encontrado"
          fi

      - name: Verificar se arquivo SARIF existe
        if: always() && steps.check-scout.outputs.enabled == 'true'
        id: check-sarif
        run: |
          if [ -f "docker-scout-report.sarif" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Arquivo SARIF encontrado"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Arquivo docker-scout-report.sarif n√£o foi gerado"
          fi

      - name: Upload SARIF
        if: always() && steps.check-scout.outputs.enabled == 'true' && steps.check-sarif.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: docker-scout-report.sarif
          category: docker-scout

  scan-trivy:
    needs: [discover, build]
    if: needs.build.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ["images/postgres-16"] # Temporariamente apenas PostgreSQL
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determinar tag para scan
        id: tag-info
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Nome da imagem para scan Trivy: ${IMAGE_NAME}"
          # Para main, usa edge ou latest (se edge n√£o existir)
          if [[ "${{ github.ref }}" == refs/heads/main ]]; then
            # Tenta edge primeiro, se n√£o existir usa latest
            SCAN_TAG="${IMAGE_NAME}:edge"
            echo "Tentando tag edge: ${SCAN_TAG}"
            # Verifica se edge existe, se n√£o, usa latest
            if ! docker manifest inspect "${SCAN_TAG}" >/dev/null 2>&1; then
              echo "Tag edge n√£o encontrada, usando latest"
              SCAN_TAG="${IMAGE_NAME}:latest"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SCAN_TAG="${IMAGE_NAME}:pr-${{ github.event.pull_request.number }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Para tags, tenta a vers√£o espec√≠fica primeiro, depois latest
            TAG_VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v\?//')
            SCAN_TAG="${IMAGE_NAME}:${TAG_VERSION}"
            echo "Tentando tag espec√≠fica: ${SCAN_TAG}"
          else
            # Fallback para latest se nada funcionar
            SCAN_TAG="${IMAGE_NAME}:latest"
          fi
          echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          echo "Escaneando com Trivy: ${SCAN_TAG}"

      - name: Verificar se imagem est√° acess√≠vel
        id: verify-image
        run: |
          SCAN_TAG="${{ steps.tag-info.outputs.scan-tag }}"
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Verificando se imagem ${SCAN_TAG} est√° acess√≠vel..."
          # Tenta puxar a imagem para verificar se est√° dispon√≠vel
          if docker pull "${SCAN_TAG}" 2>&1; then
            echo "‚úÖ Imagem encontrada e acess√≠vel: ${SCAN_TAG}"
            echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
          else
            echo "Aviso: Imagem ${SCAN_TAG} n√£o encontrada, tentando latest..."
            LATEST_TAG="${IMAGE_NAME}:latest"
            if docker pull "${LATEST_TAG}" 2>&1; then
              echo "‚úÖ Usando tag latest: ${LATEST_TAG}"
              echo "scan-tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            else
              echo "::warning::Imagem n√£o encontrada no GHCR. Scan pode falhar, mas continuando com tag original."
              echo "scan-tag=${SCAN_TAG}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Trivy Scan - Vulnerabilidades (Table)
        id: trivy-scan-table
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          ignore-unfixed: false

      - name: Trivy Scan - Vulnerabilidades (JSON)
        id: trivy-scan-json
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}
          format: "json"
          output: "trivy-report.json"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          ignore-unfixed: false

      - name: Converter JSON para HTML
        id: json-to-html
        continue-on-error: true
        run: |
          if [ -f "trivy-report.json" ]; then
            IMAGE_REF="${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}"
            
            cat > trivy-report.html << 'HTMLHEAD'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Trivy Vulnerability Report</title>
            <style>
              * { box-sizing: border-box; }
              body { 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                margin: 0; 
                padding: 20px; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
              }
              .container { 
                background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
                padding: 30px; 
                border-radius: 16px; 
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                max-width: 1400px;
                margin: 0 auto;
              }
              h1 { 
                color: #2d3748; 
                border-bottom: 4px solid;
                border-image: linear-gradient(90deg, #667eea, #764ba2, #f093fb) 1;
                padding-bottom: 15px;
                margin-bottom: 20px;
                font-size: 2.2em;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
              }
              .info { 
                margin: 20px 0; 
                padding: 20px; 
                background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
                border-left: 5px solid #667eea;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
              }
              .info p { margin: 8px 0; color: #2d3748; }
              .info strong { color: #667eea; }
              table { 
                border-collapse: separate;
                border-spacing: 0;
                width: 100%; 
                margin-top: 25px;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              }
              th, td { 
                padding: 15px; 
                text-align: left; 
                border-bottom: 1px solid #e2e8f0;
              }
              th { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; 
                position: sticky; 
                top: 0;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.9em;
                letter-spacing: 0.5px;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
              }
              tr:nth-child(even) { 
                background: linear-gradient(to right, #f8f9fa 0%, #ffffff 100%);
              }
              tr:hover {
                background: linear-gradient(to right, #e6f3ff 0%, #f0f8ff 100%);
                transform: scale(1.01);
                transition: all 0.2s ease;
              }
              td {
                color: #2d3748;
                font-size: 0.95em;
              }
              .critical { 
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                color: white; 
                font-weight: bold;
                padding: 6px 12px;
                border-radius: 20px;
                display: inline-block;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
                box-shadow: 0 2px 4px rgba(255,107,107,0.4);
              }
              .high { 
                background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%);
                color: white; 
                font-weight: bold;
                padding: 6px 12px;
                border-radius: 20px;
                display: inline-block;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
                box-shadow: 0 2px 4px rgba(255,165,0,0.4);
              }
              .medium {
                background: linear-gradient(135deg, #ffd93d 0%, #ffcd02 100%);
                color: #2d3748;
                font-weight: bold;
                padding: 6px 12px;
                border-radius: 20px;
                display: inline-block;
                box-shadow: 0 2px 4px rgba(255,217,61,0.4);
              }
              .low {
                background: linear-gradient(135deg, #6bcf7f 0%, #4ade80 100%);
                color: white;
                font-weight: bold;
                padding: 6px 12px;
                border-radius: 20px;
                display: inline-block;
                box-shadow: 0 2px 4px rgba(107,207,127,0.4);
              }
              .no-vuln { 
                text-align: center; 
                padding: 40px 20px; 
                color: #059669;
                font-weight: bold;
                font-size: 1.2em;
                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                border-radius: 12px;
                box-shadow: 0 4px 8px rgba(5,150,105,0.2);
              }
              .vuln-id {
                font-family: 'Courier New', monospace;
                color: #667eea;
                font-weight: 600;
              }
              .package-name {
                color: #2d3748;
                font-weight: 500;
              }
              .version {
                font-family: 'Courier New', monospace;
                color: #4a5568;
                background: #f7fafc;
                padding: 4px 8px;
                border-radius: 4px;
                display: inline-block;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üîí Trivy Vulnerability Report</h1>
              <div class="info">
                <p><strong>üì¶ Image:</strong> $IMAGE_REF</p>
                <p><strong>üìÖ Scan Date:</strong> $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>
              </div>
              <table>
                <tr>
                  <th>Vulnerability ID</th>
                  <th>Severity</th>
                  <th>Package</th>
                  <th>Installed Version</th>
                  <th>Fixed Version</th>
                  <th>Title</th>
                </tr>
          HTMLHEAD
            
            # Converter JSON para HTML usando jq (j√° dispon√≠vel no runner do GitHub)
            if command -v jq &> /dev/null; then
              VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-report.json 2>/dev/null || echo "0")
              
              if [ "$VULN_COUNT" -gt 0 ]; then
                jq -r '.Results[]?.Vulnerabilities[]? | 
                  "<tr>
                    <td><span class=\"vuln-id\">\(.VulnerabilityID // "N/A")</span></td>
                    <td><span class=\"\(.Severity // "UNKNOWN" | ascii_downcase)\">\(.Severity // "N/A")</span></td>
                    <td><span class=\"package-name\">\(.PkgName // "N/A")</span></td>
                    <td><span class=\"version\">\(.InstalledVersion // "N/A")</span></td>
                    <td><span class=\"version\">\(.FixedVersion // "N/A")</span></td>
                    <td>\(.Title // "N/A")</td>
                  </tr>"' trivy-report.json >> trivy-report.html 2>/dev/null || true
              else
                echo "<tr><td colspan='6' class='no-vuln'>‚úÖ Nenhuma vulnerabilidade CRITICAL ou HIGH encontrada!</td></tr>" >> trivy-report.html
              fi
            else
              echo "<tr><td colspan='6'>‚ö†Ô∏è jq n√£o dispon√≠vel. Instale jq para gerar relat√≥rio HTML completo.</td></tr>" >> trivy-report.html
            fi
            
            echo "</table></div></body></html>" >> trivy-report.html
            echo "‚úÖ Relat√≥rio HTML gerado com sucesso"
          else
            echo "::warning::Arquivo trivy-report.json n√£o encontrado"
          fi

      - name: Trivy Scan - Vulnerabilidades (SARIF)
        id: trivy-scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.verify-image.outputs.scan-tag || steps.tag-info.outputs.scan-tag }}
          format: "sarif"
          output: "trivy-report.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          ignore-unfixed: false

      - name: Verificar se arquivo SARIF do Trivy existe
        if: always()
        id: check-trivy-sarif
        run: |
          if [ -f "trivy-report.sarif" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Arquivo SARIF do Trivy encontrado"
            echo "Tamanho: $(stat -f%z trivy-report.sarif 2>/dev/null || stat -c%s trivy-report.sarif 2>/dev/null || echo 'N/A') bytes"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Arquivo trivy-report.sarif n√£o foi gerado"
          fi

      - name: Verificar se arquivo HTML do Trivy existe
        if: always()
        id: check-trivy-html
        run: |
          if [ -f "trivy-report.html" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Arquivo HTML do Trivy encontrado"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Arquivo trivy-report.html n√£o foi gerado"
          fi

      - name: Definir nome do artifact HTML
        id: artifact-name
        run: |
          ARTIFACT_NAME="trivy-report-html-$(echo '${{ matrix.image }}' | tr '/' '-')"
          echo "name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "Nome do artifact: ${ARTIFACT_NAME}"

      - name: Adicionar relat√≥rio HTML ao Summary
        if: always() && steps.check-trivy-html.outputs.exists == 'true'
        run: |
          if [ -f "trivy-report.html" ]; then
            echo "## üìä Relat√≥rio Trivy - Vulnerabilidades" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Extrair apenas o conte√∫do do body (sem tags html/head)
            sed -n '/<body>/,/<\/body>/p' trivy-report.html | sed '1d;$d' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload relat√≥rio HTML do Trivy
        if: always() && steps.check-trivy-html.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: trivy-report.html
          retention-days: 30

      - name: Upload SARIF do Trivy
        if: always() && steps.check-trivy-sarif.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-report.sarif
          category: trivy

  workflow-result:
    needs: [discover, build, scan, scan-trivy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Workflow Status" >> $GITHUB_STEP_SUMMARY
          echo "- Discover: ${{ needs.discover.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Scan (Docker Scout): ${{ needs.scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Scan (Trivy): ${{ needs.scan-trivy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.discover.outputs.has-changes }}" == "false" ]; then
            echo "‚ÑπÔ∏è Nenhuma imagem foi alterada, build e scans foram pulados." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Workflow executado com sucesso!" >> $GITHUB_STEP_SUMMARY
          fi
